
# ARP地址解析协议

网络层以上的协议用IP地址来标识网络接口，
但以太数据帧传输时，以**物理地址**来标识网络接口。因此我们需要进行**IP地址**与**物理地址**之间的转化。

对于IPv4来说，我们使用ARP地址解析协议来完成IP地址与物理地址的转化（IPv6使用邻居发现协议进行IP地址与物理地址的转化，它包含在ICMPv6中）。

ARP协议提供了网络层地址（IP地址）到物理地址（mac地址）之间的动态映射。
ARP协议 是地址解析的通用协议

## MAC 地址 与 IP地址

1. Mac地址由设备制造商定义/分配，每一个硬件设备都有一个链路层主地址（MAC地址），保存在设备的永久内存中。设备的mac地址不会改变（现在可以进行mac地址伪装）
2. IP地址由用户配置给网络接口， 网络接口的IP地址是可以发生变化的（通过**DHCP获取IP**，变化速度比较快）

## 获取目的端的MAC地址(在一个以太网中)步骤如下

1. 发送ARP请求的**以太网数据帧**给以太网上的每个主机，即**广播**(以太网源地址填全1)。ARP请求帧中包含了**目的主机**的IP地址。
2. 目的主机收到了该ARP请求之后，会发送一个ARP应答，里面包含了目的主机的**MAC地址**。

## ARP协议工作原理

1. 每个主机都会在自己的 **ARP 缓冲区**中建立一个 ARP 列表，以表示 IP 地址和 MAC 地址之间的对应关系。
2. 主机（网络接口）新加入网络时（也可能只是mac地址发生变化，接口重启等）， 会发送免费ARP报文把自己IP地址与Mac地址的映射关系广播给其他主机。
3. 网络上的主机接收到免费ARP报文时，会更新自己的ARP缓冲区。将新的映射关系更新到自己的ARP表中。
4. 某个主机需要发送报文时，首先检查 ARP 列表中是否有对应 IP 地址的目的主机的 MAC 地址，如果有，则直接发送数据，如果没有，就向本网段的所有主机发送 ARP 数据包(广播)，该数据包包括的内容有：源主机 IP 地址，源主机 MAC 地址，**目的主机的 IP 地址**等。
5. 当本网络的所有主机收到该 ARP 数据包时：
    （A）首先检查数据包中的 IP 地址是否是自己的 IP 地址，如果不是，则忽略该数据包。
    （B）如果是，则首先从数据包中取出源主机的 IP 和 MAC 地址写入到 ARP 列表中，如果已经存在，则覆盖。
    （C）然后将自己的 MAC 地址写入 **ARP 响应包** 中，告诉源主机自己是它想要找的 MAC 地址(单播)。

6. 源主机收到 ARP 响应包后。将目的主机的 IP 和 MAC 地址写入 ARP 列表，并利用此信息发送数据。如果源主机一直没有收到 ARP 响应数据包，表示 ARP 查询失败。